<!DOCTYPE html>
<html>
<head>
<title>Face + Uniform System</title>
<style>
body {
    background:#111;
    color:#eee;
    text-align:center;
    font-family:Arial, sans-serif;
}
#camera {
    width:80%;
    margin-top:20px;
    border-radius:12px;
    border:3px solid #333;
}
#canvas {
    position:absolute;
    left:10%;
    top:150px;
    pointer-events:none;
}
#result {
    margin-top:25px;
    padding:15px;
    font-size:22px;
    background:#222;
    border-radius:10px;
}
</style>
</head>
<body>

<h1>Face + Uniform Check</h1>

<video id="camera" autoplay playsinline></video>
<canvas id="canvas"></canvas>
<div id="result">Starting…</div>

<script>
let video = document.getElementById("camera");
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");

// Start camera
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => { video.srcObject = stream; })
.catch(err => { document.getElementById("result").innerHTML = "Camera Error"; });

// Capture frame
function captureFrame() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return new Promise(resolve => canvas.toBlob(resolve, "image/jpeg"));
}

// Draw face bounding box
function drawFaceBox(box, match) {
    if(!box) return;
    let scaleX = canvas.width / video.videoWidth;
    let scaleY = canvas.height / video.videoHeight;

    let x = box.left * scaleX;
    let y = box.top * scaleY;
    let w = (box.right - box.left) * scaleX;
    let h = (box.bottom - box.top) * scaleY;

    ctx.strokeStyle = match ? "lime" : "red";
    ctx.lineWidth = 4;
    ctx.strokeRect(x, y, w, h);

    if(match){
        ctx.font = "20px Arial";
        ctx.fillStyle = "lime";
        let id = document.getElementById("result").innerText.split(": ")[1];
        ctx.fillText("ID: "+id, x, y-10);
    }
}

// Send face to server
async function sendFace() {
    document.getElementById("result").innerHTML = "Checking face…";

    let blob = await captureFrame();
    let fd = new FormData();
    fd.append("image", blob);

    let res = await fetch("/check_face", { method:"POST", body:fd });
    let data = await res.json();

    if(data.match){
        document.getElementById("result").innerHTML = "✔ Face Match: " + data.id;
    } else {
        document.getElementById("result").innerHTML = "❌ Face Not Recognized";
    }

    drawFaceBox(data.box, data.match);
    sendUniform();
}

// Send uniform to server
async function sendUniform() {
    document.getElementById("result").innerHTML += "<br>Checking uniform…";

    let blob = await captureFrame();
    let fd = new FormData();
    fd.append("image", blob);

    let res = await fetch("/check_uniform", { method:"POST", body:fd });
    let data = await res.json();

    let status = data.uniform_ok ? "✔ Uniform OK" : "❌ Uniform Not OK";
    document.getElementById("result").innerHTML += "<br>" + status;
}

// Start process automatically after 2 seconds
setTimeout(sendFace, 2000);
</script>

</body>
</html>
